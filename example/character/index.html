<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!--
    <script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.15/require.min.js"></script>
    -->
    <script src="../dep/require.min.js"></script>
    <style>
        html, body, #main {
            height: 100%;
        }
        body {
            margin: 0px;
        }
        #qrcode {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 100px;
            height: 100px;
        }
    </style>
</head>
<body>
    <div id="main"></div>
    <img id="qrcode" />
    <script src="../js/config.js"></script>
    <script>
    require([
        'qtek/core/util',
        'qtek-app/App3D',
        'character.world',
        'male.prefab',
        'socket.io'
    ], function (qtekUtil, App3D, worldConfig, malePrefabConfig, io) {
        var app = new App3D();
        app.init(document.getElementById('main'));
        var world = app.loadWorld(worldConfig);
        var malePrefab = app.loadPrefab(malePrefabConfig);

        window.addEventListener('resize', function () {
            app.resize();
        });

        world.success(function () {
            init();
        });

        var characterInstances = {};

        function init() {

            var IP = '192.168.101.204';
            var socket = io.connect('http://' + IP + ':3000/');

            socket.on('connect_error', function () {
                console.log('连接服务器失败');
                socket.disconnect();
            });
            socket.on('connection-id', function (id) {
                console.log('connection id', id);
            });
            socket.emit('register', {
                type: 'game'
            });
            socket.on('other-close', function (id) {
                var instance = characterInstances[id];
                if (instance) {
                    world.destroyPrefabInstance(instance);
                }
                delete characterInstances[id];
            });

            socket.on('register-status', function (statusData) {
                if (statusData.status === 'success') {
                    var userData = window.localStorage['qtek-app-character-user'];
                    if (userData) {
                        userData = JSON.parse(userData);
                    } else {
                        userData = {
                            id: statusData.id,
                            position: [Math.random() * 1000, 0, Math.random() * 1000],
                            color: [Math.random(), Math.random(), Math.random()]  
                        };
                    }

                    socket.emit('join', userData);

                    document.getElementById('qrcode').src = 'http://ishowshao.com/phpqrcode/index.php?data=' + encodeURIComponent('http://' + IP + '/gamma/demo-remote.html?gameId=' + userData.id);
                    // 
                    app.broadcastEntityEvent('userInit', userData);

                    socket.on('control', function (data) {
                        switch (data.type) { 
                            case 'orientation':
                                break;
                            case 'motion':
                                break;
                            case 'stick0':
                                stickX = data.data.x;
                                stickY = data.data.y;

                                app.broadcastEntityEvent('changeSpeed', stickX, stickY);
                                break;
                            case 'stick1':
                                stickX = data.data.x;
                                stickY = data.data.y;

                                app.broadcastEntityEvent('orbit', stickX, stickY);
                                break;
                            case 'button-0':
                                app.broadcastEntityEvent('jump');
                                break;
                        }
                    });

                    socket.on('other-join', function (data) {
                        if (data.id !== userData.id) {
                            createCharacterInstance(data);
                        }
                    });

                    socket.on('other-sync', function (data) {
                        if (data.id !== userData.id) {
                            var instance = characterInstances[data.id];
                            if (instance) {
                                instance.getEntities().forEach(function (entity) {
                                    if (data.position) {
                                        entity.broadcastComponentEvent('updatePositionAndRotation', data.position, data.rotation);
                                    } else if (data.speed) {
                                        entity.broadcastComponentEvent('characterChangeSpeed', data.speed.x, data.speed.y);
                                    }
                                });
                            }
                        }
                    });

                    socket.on('enter', function (data) {
                        data.forEach(function (item) {
                            if (item.id !== userData.id) {
                                qtekUtil.extend(item.join, item.sync);
                                createCharacterInstance(item.join);
                            }
                        });

                        app.start();
                    });

                    var createCharacterInstance = function (data) {
                        var instance = world.instantiatePrefab(malePrefab);
                        instance.getEntities().forEach(function (entity) {
                            entity.broadcastComponentEvent('characterUserInit', data);
                        });
                        characterInstances[data.id] = instance;

                        return instance;
                    }

                    app.on('selfSync', function (data) {
                        data.id = userData.id;
                        socket.emit('sync', data);
                    });
                }
            });
        }
    });
    </script>
</body>
</html>